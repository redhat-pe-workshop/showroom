
:imagesdir: ../../assets/images

include::../style.adoc[]

== {product_name_rhdh} Deployment

=== Deploying {product_name_rhdh}

Platform Engineers can deploy {product_name_rhdh} on OpenShift using the Operator or Helm Chart. Both of these installation methods are outlined in the https://docs.redhat.com/en/documentation/red_hat_developer_hub/1.3/html/installing_red_hat_developer_hub_on_openshift_container_platform/index#assembly-install-rhdh-ocp-helm[{product_name_rhdh} documentation]. In this lab you'll use the Helm Chart to deploy and manage your instance of {product_name_rhdh}. The source code for this Helm Chart can be found at https://github.com/openshift-helm-charts/charts/tree/main/charts/redhat/redhat/redhat-developer-hub[openshift-helm-charts repository on GitHub].

=== Using GitOps to Manage {product_name_rhdh}

The instance of OpenShift Container Platform used in this workshop environment has been preconfigured with OpenShift GitOps (Argo CD). Your deployment of {product_name_rhdh} is kept up to date using a GitOps workflow, as illustrated below.

// TODO: replace with product icons

image:m2/gitops-helm.png[GitOps Architecture Overview, width=80%]

Since this isn't a GitOps-focused workshop, we've setup the basic GitOps workflow ahead of time. 

* Navigate to ArgoCD through this  https://openshift-gitops-server-openshift-gitops.{openshift_cluster_ingress_domain}[link, window="argo"], and log in as the `admin` user with the password `{openshift_gitops_password}`.
* As part of this workshop's setup. the `backstage-bootstrap` ArgoCD Application has been created with  a set of Secrets, ConfigMaps, and more importantly another ArgoCD Application named `backstage`. 
+
image:m2/backstage_bootstrap_app.png[] 

* Click on the image:m2/out-arrow.png[width=4%] in the `backstage` application or click this https://openshift-gitops-server-openshift-gitops.{openshift_cluster_ingress_domain}/applications/openshift-gitops/backstage[link to backstage, window="argo"] to view this ArgoCD Application.
** The `backstage` ArgoCD application deploys {product_name_rhdh} using the Helm Chart from https://charts.openshift.io[https://charts.openshift.io^, window="content"]. The configuration values passed to the Helm Chart are sourced from the https://gitlab-gitlab.{openshift_cluster_ingress_domain}/rhdh/developer-hub-config/-/blob/main/values.yaml[rhdh/developer-hub-config/values.yaml file in GitLab, window="gitlab"]. OpenShift GitOps will detect changes to this file and redeploy {product_name_rhdh} in response. 
* Click on the *DETAILS* menu on top left of the page, and choose the *SOURCES* tab.
+
image:m2/backstage-argo.png[] 

* The *Source 1* links to the Helm chart of {product_name_rhdh}, and the *Source 2* is the Gitlab repository where the values needed by the Helm chart are stored. Throughout this workshop, you will make changes to this file to progressively configure {product_name_rhdh}.

+
image:m2/gitops-sources.png[GitOps Sources for the Backstage Application]

=== Platform Engineer Activity: Verify GitOps is Working

*Update the App Title of {product_name_rhdh}*

Let's verify that changes to the https://gitlab-gitlab.{openshift_cluster_ingress_domain}/rhdh/developer-hub-config/-/blob/main/values.yaml[values.yaml file in GitLab, window="gitlab"] actually get rolled out by OpenShift GitOps.

. Open your https://gitlab-gitlab.{openshift_cluster_ingress_domain}/rhdh/developer-hub-config/-/blob/main/values.yaml[values.yaml file, window="gitlab"].
. Select *Edit > Edit single file*. When prompted, login as a Platform Engineer with `pe1/{common_password}`
. Find the YAML surrounded by `--- APP TITLE ---` and uncomment it by highlighting it and pressing `CMD + /` or `CTRL + /`.
+
image:m2/gitlab-change-app-title.png[Customizing the Title]
. Scroll down and enter a commit message `feat: change application title`.
. Click the *Commit changes* button.


*Verify update to {product_name_rhdh}'s Custom Title*

Let's wait for the new deployment of {product_name_rhdh} to complete to check if the custom title reflects as it should on {product_name_rhdh}

. Return to the https://openshift-gitops-server-openshift-gitops.{openshift_cluster_ingress_domain}/applications/openshift-gitops/backstage[backstage Application in Argo CD, window="argo"]. Depending on your timing, it might already be progressing the latest sync, but if not, click the *Refresh* button. When the sync is in progress, you'll see a new Pod starting - this Pod will run the latest version of your configuration.
+
image:m2/rhdh-new-pod.png[{product_name_rhdh} with a Custom Title]

. Once the new Pod has started, visit your https://backstage-backstage.{openshift_cluster_ingress_domain}[{product_name_rhdh} instance, window="rhdh"]. You should see the new title *PE Developer Hub* in the page header.
+
image:m2/rhdh-title.png[{product_name_rhdh} with a Custom Title]
