:imagesdir: ../../assets/images


== Platform Engineer Activity: Setup Software Templates Import Existing API/Apps

include::../style.adoc[]

The Platform Engineering team creates two Templates for importing existing applications/services, and APIs into {product_name_rhdh}. While it is possible to use the same template to import both of them, there are some key differences in the data that must be gathered. Per best practice, the Platform Engineering team creates as many Software Templates as necessary to assist developers.


You are most probably quite familiar by now how to login as a *Platform Engineer* with pe1/{common_password}. If you are unsure, please refer to the below note.

.Click to know how to login as a Platform Engineer
[%collapsible]
====
include::../login-pe.adoc[]
====


== Register the Import Software Templates

=== Procedure Overview 

You learned how to create a Software Template in module 3. In this section we will walk through a Template that has been pre-built for you. 

Click https://gitlab-gitlab.{openshift_cluster_ingress_domain}/rhdh/import-existing-api-template/-/blob/main/template.yaml[here^, window="gitlab"] to view the `import-existing-app` Software Template you'll be using.

This template does the following:

. Gather details of the API, the target location (repository) of catalog info, and the details of the software component.
+
image:m4/st-api-params.png[width=70%]
. Update the *Envelope* location file with the details as a two step process.
+
image:m4/st-api-steps.png[width=70%]

[NOTE]
====
*Why are two merge requests necessary?*

GitLab allows only one type of action (such as Amend/Update) in a given Merge Request (MR). Therefore, we need one MR to _create_ the new catalog-info and TechDocs file, and another MR to _update_ the location file with a reference to the catalog-info.yaml file
====

=== Register the Import API Software Template

. Access {product_name_rhdh} (https://backstage-backstage.{openshift_cluster_ingress_domain}[click here^, window="rhdh"]). If prompted login using `pe1/{common_password}`
. Click on the *Create* menu on the left-hand navigation. 
+
image::m4/nav-create.png[]
. Click on the *Register Existing Component* button on the top-right of the page to launch the *Register an existing component* wizard. 
. Paste the following URL into the *Select URL* field and click on *Analyze* button. This URL points to Software Template's https://gitlab-gitlab.{openshift_cluster_ingress_domain}/rhdh/import-existing-api-template/-/blob/main/template.yaml[template.yaml, window="gitlab"] file.
+ 
[source,bash,role=execute,subs="attributes"]
----
https://gitlab-gitlab.{openshift_cluster_ingress_domain}/rhdh/import-existing-api-template/-/blob/main/template.yaml
----
+
image::m4/nav-register-wizard.png[]
. Review, and import the template by clicking on the *Import* button.
+
image::m4/nav-register-import.png[]

. The *import-api-catalog* Template is successfully registered.
+
image::m4/nav-access-api-template.png[]

=== Register Import App Software Template

. Let us now register the *Import existing application* template as well.
. Click *Create* (left hand nav) -> *Register Existing Component* (top right)
. Paste the following URL:
+
[source,bash,role=execute,subs="attributes"]
----
https://gitlab-gitlab.{openshift_cluster_ingress_domain}/rhdh/import-existing-app-template/-/blob/main/template.yaml
----
. Review and import the template by clicking on the *Import* button

=== View the Imported Templates

Navigate back to *Create* using the side menu. You should see both the templates for importing APIs and applications to {product_name_rhdh}.

image::m4/import-templates-list.png[]


== Setup {product_name_rhdh} config

The new templates require a set of dynamic plugins to function correctly: 

* *roadiehq-scaffolder-backend-module-utils-dynamic*: used to manipulate the file system. In this case it's used to update the location file with references to the new component being imported.
* *backstage-plugin-catalog-backend-module-gitlab-dynamic*: enables auto-discovery of `catalog-info.yaml` files located in your GitLab instance.

=== Enable Dynamic Plugins 


. You will also enable a couple of Community plugins which will help view Merge requests and Issues from GitLab
. Visit your https://gitlab-gitlab.{openshift_cluster_ingress_domain}/rhdh/developer-hub-config/-/edit/main/values.yaml[rhdh/developer-hub-config repository on GitLab^, window="gitlab"]. If prompted, login with `pe1/{common_password}`.
. You should already be in Edit mode of the `values.yaml` file.
. Locate the comment `--- DYNAMIC_PLUGINS_IMPORT_COMPONENTS ---`
. Highlight the YAML section shown in the below screenshot, and uncomment those lines. Use `CMD + /` or `CTRL + /` to do so.
+
image::m4/uncomment-dynamic-plugin.png[width=60%]
. Don't commit the changes yet - you need enable auto-discovery.

=== Enable Auto-Discovery
. Locate the comment `--- AUTO_DISCOVERY_IMPORT_COMPONENTS ---` in the same `values.yaml` file.
. Highlight the YAML as shown in the below screenshot, and comment those lines.
+
image::m4/uncomment-auto-discovery.png[width=60%]
+
NOTE: This YAML snippet enables auto-discovery for all files named _envelope.yaml_ (entityFilename) where the repo name starts with the word _envelope_ (projectPattern). The Catalog Envelope for Parasol is called _envelope-catalog-parasol_.
. Go ahead and commit the file now using the *Commit Changes* button at the bottom of the page with a suitable commit message.
+
image::m4/commit-rhdh-config.png[]

. Refresh Red Hat Developer Hub instance on https://openshift-gitops-server-openshift-gitops.{openshift_cluster_ingress_domain}[ ArgoCD^, window="argo"]. Login as (admin/{openshift_gitops_password}). Click on the *Refresh* button of the *backstage*  ArgoCD Application to trigger a refresh. Wait until the Application turns green and marked as Healthy. 


== Onboard Parasol's System and Domain

In a previous chapter you learned how https://backstage.io/docs/features/software-catalog/system-model#system[System,window="content"] and https://backstage.io/docs/features/software-catalog/system-model/#domain[Domain,window="content"] Entities help organize and provide a hierarchy of Components in {product_name_rhdh}. In this section you will setup Parasol's System and Domain.

. From {product_name_rhdh}, navigate to Create menu; choose *Register Existing Component* button
. Paste the below URL and click on *Analyze*
+
[source,bash,role=execute,subs="attributes"]
----
https://gitlab-gitlab.{openshift_cluster_ingress_domain}/rhdh/rhdh-entities/-/blob/main/locations.yaml
----
. Click *Import* in the Review section.
. The Systems and Domain are setup. 

[NOTE]
====
Systems are the basic level of encapsulation for related entities. Domains are useful to group a collection of Systems that share terminology, domain models, business purpose etc.
====
